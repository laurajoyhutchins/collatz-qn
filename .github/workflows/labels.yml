# .github/workflows/labels.yml
name: Sync Labels

on:
  workflow_dispatch:
    inputs:
      allow_delete:
        description: "Delete labels not in target schema"
        type: boolean
        default: false
      dry_run:
        description: "Plan only; do not modify"
        type: boolean
        default: false
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 3 * * 0"   # Sundays 03:00 UTC

permissions:
  contents: read
  issues: write    # required to manage labels

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: pip install requests

      - name: Write script
        run: |
          cat > labels_sync.py <<'PY'
          # paste the reconciler script here unchanged
          PY

      - name: Dry-run or apply
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ github.token }}
          ALLOW_DELETE: ${{ inputs.allow_delete }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          if [ "${DRY_RUN}" = "true" ]; then
            python3 labels_sync.py --repo "${REPO}" --token "DRY_RUN" $([ "${ALLOW_DELETE}" = "true" ] && echo --allow-delete)
          else
            python3 labels_sync.py --repo "${REPO}" --token "${TOKEN}" $([ "${ALLOW_DELETE}" = "true" ] && echo --allow-delete)
          fi